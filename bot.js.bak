const https = require("https");
const TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const CASINO_URL = process.env.CASINO_URL || "https://example.com/";
if (!TOKEN) { console.error("TELEGRAM_BOT_TOKEN env is missing"); process.exit(1); }
const API = `https://api.telegram.org/bot${TOKEN}`;
let offset = 0;
function apiPost(method, body) {
  return new Promise((resolve, reject) => {
    const data = JSON.stringify(body);
    const url = `${API}/${method}`;
    const req = https.request(url, { method: "POST", headers: { "Content-Type": "application/json", "Content-Length": Buffer.byteLength(data) } }, (res) => {
      let out = ""; res.on("data", (chunk) => (out += chunk)); res.on("end", () => { try { resolve(JSON.parse(out)); } catch (e) { resolve(out); } });
    });
    req.on("error", reject); req.write(data); req.end();
  });
}
function apiGet(method, params) {
  const qs = new URLSearchParams(params || {}).toString();
  const url = `${API}/${method}${qs ? `?${qs}` : ""}`;
  return new Promise((resolve, reject) => {
    https.get(url, (res) => { let out = ""; res.on("data", (chunk) => (out += chunk)); res.on("end", () => { try { resolve(JSON.parse(out)); } catch (e) { resolve(out); } }); }).on("error", reject);
  });
}
async function handleUpdate(update) {
  offset = Math.max(offset, (update.update_id || 0) + 1);
  const msg = update.message; if (!msg) return; const chatId = msg.chat.id; const text = msg.text || "";
  if (text.startsWith("/start")) {
    await apiPost("sendMessage", { chat_id: chatId, text: "ткрой мини?приложение слота", reply_markup: { inline_keyboard: [[{ text: "ткрыть слот", web_app: { url: CASINO_URL } }]] } });
    await apiPost("sendMessage", { chat_id: chatId, text: `Сайт казино: ${CASINO_URL}`, disable_web_page_preview: false });
  }
}
async function poll() {
  try {
    const res = await apiGet("getUpdates", { timeout: 20, offset, allowed_updates: "message" });
    if (res && res.ok && Array.isArray(res.result)) { for (const upd of res.result) { await handleUpdate(upd); } }
  } catch (e) {} finally { setTimeout(poll, 1500); }
}
console.log("Bot started"); poll();
